# ============================================================================
# POC-04-B: Keycloak SAML2 Federation with External Roles Provider
# ============================================================================
# Services:
# 1. keycloak-idp (8180): Identity Provider - usuarios nativos
# 2. keycloak-sp (8080): Service Provider - usuarios federados + JAR custom
# 3. keycloak-idp-db: PostgreSQL para Keycloak IdP
# 4. keycloak-sp-db: PostgreSQL para Keycloak SP
# 5. roles-db: PostgreSQL externa con roles (compartida)
# ============================================================================

services:
  # ==========================================================================
  # External Roles Database (shared)
  # ==========================================================================
  roles-db:
    image: postgres:16-alpine
    container_name: poc04b-roles-db
    restart: unless-stopped

    environment:
      POSTGRES_DB: roles
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"

    volumes:
      - ./init-db:/docker-entrypoint-initdb.d:ro
      - roles-db-data:/var/lib/postgresql/data

    ports:
      - "5433:5432"

    networks:
      - keycloak-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d roles"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Keycloak IdP Database
  # ==========================================================================
  keycloak-idp-db:
    image: postgres:16-alpine
    container_name: poc04b-keycloak-idp-db
    restart: unless-stopped

    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"

    volumes:
      - keycloak-idp-db-data:/var/lib/postgresql/data

    ports:
      - "5434:5432"

    networks:
      - keycloak-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Keycloak SP Database
  # ==========================================================================
  keycloak-sp-db:
    image: postgres:16-alpine
    container_name: poc04b-keycloak-sp-db
    restart: unless-stopped

    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"

    volumes:
      - keycloak-sp-db-data:/var/lib/postgresql/data

    ports:
      - "5432:5432"

    networks:
      - keycloak-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # Keycloak IdP (Identity Provider) - Puerto 8180
  # ==========================================================================
  # Vanilla Keycloak que actúa como IdP SAML
  # Contiene los usuarios nativos (alan.turing, test.user)
  # ==========================================================================
  keycloak-idp:
    build:
      context: .
      dockerfile: docker/keycloak-idp/Dockerfile
    container_name: poc04b-keycloak-idp
    restart: unless-stopped

    depends_on:
      keycloak-idp-db:
        condition: service_healthy

    environment:
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-idp-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak

      # Admin credentials
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin

      # Runtime settings
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_HOSTNAME: localhost
      KC_HOSTNAME_PORT: "8180"
      KC_PROXY: edge
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_LOG_LEVEL: info

    ports:
      - "8180:8080"

    networks:
      - keycloak-network

    command:
      - start
      - --optimized
      - --http-enabled=true
      - --hostname-strict=false

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 90s

  # ==========================================================================
  # Keycloak SP (Service Provider) - Puerto 8080
  # ==========================================================================
  # Keycloak con JAR custom que actúa como SP SAML
  # Recibe usuarios federados del IdP via SAML2
  # Consulta roles externos en PostgreSQL
  # ==========================================================================
  keycloak-sp:
    build:
      context: .
      dockerfile: docker/keycloak-sp/Dockerfile
    container_name: poc04b-keycloak-sp
    restart: unless-stopped

    depends_on:
      keycloak-sp-db:
        condition: service_healthy
      roles-db:
        condition: service_healthy

    environment:
      # Database configuration
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-sp-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak

      # Admin credentials
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin

      # External roles database configuration
      ROLES_DB_URL: jdbc:postgresql://roles-db:5432/roles
      ROLES_DB_USER: keycloak
      ROLES_DB_PASSWORD: keycloak
      ROLES_DB_POOL_SIZE: 10
      ROLES_DB_MIN_IDLE: 2
      ROLES_DB_CONN_TIMEOUT: 30000
      ROLES_DB_IDLE_TIMEOUT: 600000
      ROLES_DB_MAX_LIFETIME: 1800000

      # Runtime settings
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
      KC_LOG_LEVEL: info
      QUARKUS_LOG_CATEGORY__COM_EXAMPLE_KEYCLOAK__LEVEL: debug

    ports:
      - "8080:8080"

    networks:
      - keycloak-network

    command:
      - start
      - --optimized
      - --http-enabled=true
      - --hostname-strict=false

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10
      start_period: 90s

# ============================================================================
# Networks
# ============================================================================
networks:
  keycloak-network:
    name: poc04b-network
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================
volumes:
  roles-db-data:
    name: poc04b-roles-db-data
  keycloak-idp-db-data:
    name: poc04b-keycloak-idp-db-data
  keycloak-sp-db-data:
    name: poc04b-keycloak-sp-db-data
